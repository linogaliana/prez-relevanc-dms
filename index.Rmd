---
title : "Enrichissement de données de caisses à partir d’informations nutritionnelles"
subtitle : "Une approche par appariement flou sur données de grande dimension"
author : "Lino Galiana(1) ; Milena Suarez-Castillo(2) ; Lionel Wilner(1)"
institute : "(1) D2E, (2) SSP-lab"
date : "9 Décembre 2021"
output :
    utilitr::utilitr_presentation:
        css:
        - css/custom.css
        nature:
          highlightStyle: github
          highlightLines: true
          countIncrementalSlides: false
---

```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)
knitr::opts_chunk$set(echo = FALSE)
```



# Introduction

## Problématique (1/2)

* Alimentation affecte variables de santé publique ayant un effet de premier ordre sur bien-être :
    + obésité
    + mortalité différentielle
* Interaction avec les inégalités socioéconomiques: Caillavet et al. (2020)
* Alcott et al. (2019) proposent une décomposition entre effets:
    + d'offre (déserts alimentaires)
    + de demande (préférences pour la \textit{junk food})
* Facteurs sociaux et territoriaux interagissent
* Malgré réglementations (ex: nutriscore), beaucoup d'asymétries d'information
* Commencer par documenter les inégalités de "qualité" de consommation
    + Avant d'essayer de distinguer effets offre et demande


---
# Introduction

## Problématique (2/2)

* Au sein d'une classe de produit (ex: lasagnes), énormément d'hétérogénéité de "qualité"
    + Low-cost vs autres produits
    + Bio vs agriculture traditionnelle
* Besoin de données très fines pour distinguer les qualités nutritionnelles (Caillavet et al. 2020)
* D'où l'utilisation de sources de collectes automatisées:
    + Données d'enquête (notamment Budget des Familles) serviront à vérifier la cohérence voire caler
    + Autres sources administratives pour contrôler la qualité des données

---
# Introduction

## Enjeux

* Besoin d'enrichissements multiples:
    + Sur la dimension géographiques
    + Sur la dimension produit
* Méthode des appariements flous 
    + Compenser absence d'identifiants pour appariements exacts
    + Noms produits
    + Adresse magasins
* Catégorisation pour réduire le nombre de paires
    + COICOP
    + Département
* Approche généralisable à de nombreux problèmes de la stat publique


---
#  Données

## RelevanC

* Données de caisses du groupe Casino
    + Casino, Monoprix, Franprix au niveau magasin et 
    + Leader Price et des petites chaînes (stations services, Sherpa...) au niveau magasin exclusivement
* $\approx$ 11 000 magasins
* $\approx$ 250 000 produits


---
#  Données

## RelevanC

```{r}
knitr::include_graphics("images/schema-structure.drawio.png")
```


---
#  Données

## OpenFoodFacts (![openfoodfacts.org](https://fr.openfoodfacts.org))

* Base de données contributive et open-source (alternative à \texttt{Yuka})
    + Actualisée en continu
    +  Mise à disposition de csv de manière quotidienne
    +  Plusieurs API
* $\approx$ 2 millions de produits
* Beaucoup d'infos disponibles
    + Scores de qualité agrégés : nutriscore, score NOVA, écoscore
    + Infos nutritionnelles: calories, glucides, lipides, etc.
    + Infos sur produit: packaging, etc.
* \textit{Challenge}:  qualité et taux de complétude variable
    + Valeurs manquantes
    + Erreurs de remplissage et fautes d'ortographe


---
#  Données

## CIQUAL (![ciqual.anses.fr](https://ciqual.anses.fr/))

* Base de données élaborée par l'Anses
    + Produits standardisées
    + Beaucoup d'infos disponibles
    + \textit{Challenge}:  meilleure qualité mais produits standardisés
* Perte d'une dimension dans l'hétérogénéité produit
    + Globalement même information qu'\texttt{OpenFoodFacts}
* Besoin d'enrichir certaines classes de produits:
    + Faible variabilité nutritionnelle
    + Forte hétérogénéité des labels des sous-classes: marques, domaines, goûts...

---
#  Données

## Dictionnaires de produits via Wikipédia (![mediawiki.org](https://www.mediawiki.org/wiki/API))

```{r}
knitr::include_graphics('images/wikipedia.pdf')
```


---
# Modèle `fasttext` COICOP

Réutilisation d'un output du projet \texttt{PAul-EAN}: modèle de prédiction de la classe COICOP entrainé sur \textit{l'ensemble} des données de caisse à deux niveaux:

* COICOP prédite comme variable de blocage
* Création d'une \textit{distance} ad-hoc entre libellés via un plongement de mots, qui est initialisé sur le plongement de mots issu de ce modèle 


---
# Appariement produits: vue globale

```{r}
knitr::include_graphics('images/macro.png')
```


---
# Data cleaning et catégorisation

```{r}
knitr::include_graphics('images/macro-ombre2.png')
```

---
# Enjeu du data cleaning

* Réduire le bruit dans les données ;
* Harmoniser les jeux de données ;
* Détecter des produits non alimentaires malgré filtre rayons.

```{r, fig.show="hold", out.width="50%"}
knitr::include_graphics('images/openfood_start.png')
knitr::include_graphics('images/relevanc_start.png')
```

---
# Pipeline de data-cleaning


```{r}
knitr::include_graphics("images/step2-cleaning-categorisation.drawio.png")
```

---
# Pipeline de data-cleaning
## Premières étapes: définir le champ le plus précis et cohérent possible

1. Consolidation des bases des différentes chaînes
2. Elimine des produits non alimentaires (\texttt{RelevanC} et \texttt{OpenFood})
3. Retire des abbréviations qui apportent du bruit

```{r}
knitr::include_graphics("images/step2-cleaning-categorisation-part1.png")
```

---
# Pipeline de data-cleaning
## Premières étapes: définir le champ le plus précis et cohérent possible

3. Identification par expression régulière d'infos sur le produit
    + Remplacement par des mots-clés (\texttt{#VOLUME}, \texttt{#POIDS}, \texttt{#UNITE}, \texttt{#LOT}...) pour la classification
    + Suppression de ces infos pour le libellé d'appariement flou

```{python, eval = FALSE, echo = TRUE}
r'\d+\.?\d*\s?(K?G(R|E)?(X\d+)?)\b': '{}'.format(weigt_exp),
r'\d+\.?\d*\s?([CM]?L)\b': '{}'.format(vol_exp),
r'\d+\s?(X|\*)\s?\d*\b': '{}'.format(lot_exp),
```

```{r}
knitr::include_graphics("images/step2-cleaning-categorisation-part2.png")
```

---
# Pipeline de data-cleaning
## Deuxième étape: normalisation des noms de produits

4. Transformation en suite d'unités signifiantes (\textit{token})
    + Retrait des \textit{stopwords} qui n'apporte pas d'info sur le produit 
    + Mots comme token
    + \texttt{nltk} plutôt que \texttt{spaCy}
    + Pas de \textit{stemming}
    + Les n-grams sont définis au niveau de la requête \texttt{Elastic}

```{r}
knitr::include_graphics("images/step2-cleaning-categorisation-part2.png")
```


---
# Pipeline de data-cleaning
## Deuxième étape: normalisation des noms de produits


* Réduire le bruit dans les données ;
* Harmoniser les jeux de données ;
* Détecter des produits non alimentaires malgré filtre rayons.

```{r, fig.show="hold", out.width="50%"}
knitr::include_graphics('images/openfood_tokenized.png')
knitr::include_graphics('images/relevanc_tokenized.png')
```

# Pipeline de data-cleaning
## Deuxième étape: normalisation des noms de produits

|                 Libellé d'origine |          Libellé tokenisé |             Libellé classification  |
|-----------------------------------|---------------------------|-------------------------------------|
|                  NUTELLA POT 225G |               nutella pot |                 NUTELLA POT #POIDS  |
|          PULCO DELICE AGRUME 70CL |       pulco delice agrume |        PULCO DELICE AGRUME #VOLUME  |
|Cristaline Eau de source - 1,5 l & |   cristaline eau source & | CRISTALINE EAU DE SOURCE #VOLUME    |
|             COCA COLA CANETTE 1KG |         coca cola canette |           COCA COLA CANETTE #POIDS  |
|           Brioche tranchée nature |   brioche tranchee nature |             BRIOCHE TRANCHEE NATURE |
|               °RELIGIEUSE CAFE X2 |        degreligieuse cafe |            DEGRELIGIEUSE CAFE #LOT  |
|1/2 CHEVREAU S/TET S/ABA 2,5KG ENV |      chevreau tet aba env |    12 CHEVREAU STET SABA #POIDS ENV |
|   SAINT EMILION PUY RAZAC RG 75CL | saint emilion puy razac   | SAINT EMILION PUY RAZAC RG #VOLUME  |

---
# Classification
## Classement dans la COICOP

* Chercher un nom de produit proche dans $\approx$ 2 millions est une tâche excessivement complexe...
* ... surtout quand on doit le faire 250 000 fois
* Equivalent à un produit cartésien de $10^{13}$ opérations (nombre de cellules dans le corps humain)
* Trouver une variable de blocage pour n'associer qu'une partie des paires entre-elles:
    + Améliore la pertinence de la recherche
    + Réduit drastiquement la complexité du problème
* Pas de variable commune dans nos différentes sources:
    + Rayon: faible qualité, pas correspondance 
* Utilisation COICOP

---
# Classification
## Classement dans la COICOP

* Réseau neurone entraîné sur données de caisses
* Utilisation des poids estimés grâce au binaire \texttt{fasttext}
* Jamais accès aux données d'entraînement
* Classement à un niveau très fin (plus fin que niveau poste)
    + \texttt{01.2.2.1.1}: \textit{Eaux minérales et de source}

```{r}
knitr::include_graphics("images/step2-cleaning-categorisation-part3.png")
```

---
# Classification
## Exemples

|                 Libellé d'origine |    Libellé tokenisé |             Libellé classification  |
|-----------------------------------|---------------------|-------------------------------------|
                  NUTELLA POT 225G  |     01.1.8.3.2.0001 |               Confiseries à base de chocolat |
          PULCO DELICE AGRUME 70CL  |     01.2.2.2.1.9999 |                    Boissons rafraîchissantes |
             COCA COLA CANETTE 1KG  |     01.2.2.2.1.0005 |                    Boissons rafraîchissantes |
  Cristaline Eau de source - 1,5 l  |     01.2.2.1.1.9999 |                  Eaux minérales ou de source |
              CITRONS VERTS FILETS  |     01.1.9.4.1.0006 |                        Plats cuisinés n.c.a. |
           Brioche tranchée nature  |     01.1.1.3.1.0001 |                                         Pain |
               °RELIGIEUSE CAFE X2  |     05.6.1.2.1.9999 | Petits articles pour l'entretien du logement |
1/2 CHEVREAU S/TET S/ABA 2,5KG ENV  |     01.1.2.3.1.9999 |                     Mouton, agneau et chèvre |
   SAINT EMILION PUY RAZAC RG 75CL  |     02.1.2.1.2.0005 |                              Vins supérieurs |


---
# Appariement
## Pipeline général

* On recherche dans OpenFood/CIQUAL un produit des données de caisses
* Une procédure pour aller de l'appariement le plus certain
au plus incertain
    + Appariement EAN si disponible dans OpenFood
    + Appariement flou dans les produits OpenFood ayant le même code COICOP
    + Appariement flou dans tous les produits OpenFood
    + Appariement flou dans tous les produits CIQUAL (enrichie avec le dico Wikipedia)
* Critères de validation conservateurs pour exclure faux positifs

---
# Appariement
## Pipeline général

* Code \texttt{Python} pour gérer ce \textit{pipeline}
* Package \texttt{foodbowl} %\emoji{ramen} %{\fontspec{Symbola}\symbol{"1F35C}}
    + Gère la connexion à S3 et Elastic
    + Mise en forme des requêtes, récupération des échos...
    + Validation des \textit{outputs} (distance textuelle et potentiellement réseau de neurone \texttt{PyTorch})
    + Déploiement sous forme d'API grâce à \texttt{fastAPI} (à venir)

---
# Etape 1
## Appariement EAN

* EAN est un identifiant produit unique (en principe...)
* Permet un appariement exact entre \texttt{RelevanC} et \texttt{OpenFood}
* Pour la calorie (catégorie la mieux renseignée): permet d'enrichir 46\% des données \texttt{RelevanC}



---
# Etape 2
## Objectif du fuzzy matching

```{r}
knitr::include_graphics("images/elastic-openfood-lasagnas.drawio.png")
```

---
# Etape 2
## Pourquoi ElasticSearch ?

| Approche | Temps de calcul (en secondes) |
|----------|-----------------|
|elastic    |            0.92 |
|rapidfuzz  |           97.20 |
|fuzzywuzzy |           99.90 |